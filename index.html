<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§ÛŒØ±Ø§Ù† Ø±Ù¾</title>
    <!-- ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ ØªÙ… Ø±Ù¾ -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&family=Lalezar&display=swap" rel="stylesheet">

<style>
    /* --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§ÛŒÙ‡ --- */
    body {
        font-family: 'Vazirmatn', sans-serif;
        background-color: #111;
        color: #FFFFFF;
        margin: 0;
        padding: 0;
        overflow: hidden;
        direction: rtl;
        font-size: 16px; /* Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙÙˆÙ†Øª Ù¾Ø§ÛŒÙ‡ */
    }

    * {
        box-sizing: border-box;
        -webkit-user-select: none; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ù…ØªÙ† */
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent; /* [Ø§ØµÙ„Ø§Ø­] Ø­Ø°Ù Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø¢Ø¨ÛŒ Ø¯Ø± Ú©Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡ */
    }

    /* --- Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ --- */
    .background-image {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('https://s6.uupload.ir/files/inshot_Û²Û°Û²ÛµÛ±Û°Û²Û³_Û²Û°Û±Û·Û³ÛµÛ´Û°Û¹_fc2i.jpg');
        background-size: cover;
        background-position: center;
        z-index: -1;
        filter: blur(8px) brightness(0.6);
        transform: scale(1.1);
        transition: filter 0.5s ease;
    }

    /* --- Ù…Ø¯ÛŒØ±ÛŒØª ØµÙØ­Ø§Øª Ùˆ Ù¾Ù†Ù„â€ŒÙ‡Ø§ --- */
    .screen, .panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        opacity: 1;
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        z-index: 10;
    }

    .panel {
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        z-index: 100;
    }

    .hidden {
        opacity: 0;
        pointer-events: none;
        transform: translateY(20px);
    }
    .panel.hidden {
         transform: translateY(100%);
    }

    /* --- Ø¹Ù†Ø§ØµØ± UI Ø³ÙØ§Ø±Ø´ÛŒ: Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ --- */
    .btn {
        background-color: #325A9E;
        color: #FFFFFF;
        border: none;
        padding: 14px 30px;
        font-size: 1.2rem;
        font-family: 'Vazirmatn', sans-serif;
        font-weight: 700;
        border-radius: 40px;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        transition: all 0.3s ease-in-out;
        margin: 12px;
        min-width: 240px;
        text-align: center;
        text-decoration: none;
        position: relative;
        overflow: hidden;
        letter-spacing: 0.5px;
        outline: none;
    }

    .btn:focus, .btn:active {
        outline: none;
        box-shadow: 0 0 20px #FFB800, 0 0 30px #FFB800, 0 8px 20px rgba(0,0,0,0.6);
        transform: translateY(-3px) scale(1.02);
        border: 1px solid #FFB800;
    }

    .btn:before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: width 0.4s ease, height 0.4s ease;
        z-index: 0;
    }

    .btn:hover:before {
        width: 300%;
        height: 300%;
    }

    .btn:hover {
        box-shadow: 0 0 20px #FFB800, 0 0 30px #FFB800, 0 8px 20px rgba(0,0,0,0.6);
        transform: translateY(-3px) scale(1.02);
        color: #FFF;
        border: 1px solid #FFB800;
    }

    .btn-secondary {
        background-color: #8A2BE2;
    }
    .btn-secondary:hover {
         box-shadow: 0 0 20px #8A2BE2, 0 0 30px #8A2BE2, 0 8px 20px rgba(0,0,0,0.6);
         border: 1px solid #8A2BE2;
    }

    /* --- [ØªØºÛŒÛŒØ±] Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¯Ø± Ù…Ø±Ú©Ø² ØµÙØ­Ù‡ --- */
    .main-menu-actions {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        gap: 15px;
    }
    .main-menu-actions .btn {
        font-size: 1.25rem; /* Ú©Ø§Ù‡Ø´ Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙÙˆÙ†Øª */
        padding: 16px 35px; /* Ú©Ø§Ù‡Ø´ Ù¾Ø¯ÛŒÙ†Ú¯ */
        min-width: 260px; /* Ú©Ø§Ù‡Ø´ Ø­Ø¯Ø§Ù‚Ù„ Ø¹Ø±Ø¶ */
        border-radius: 50px;
        border: 1px solid #8A2BE2;
        background: linear-gradient(45deg, #4a1c8a, #325A9E); /* Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª Ø¬Ø°Ø§Ø¨ */
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    .main-menu-actions .btn:hover {
        border-color: #FFB800;
        transform: translateY(-4px) scale(1.03);
        box-shadow: 0 0 25px #FFB800, 0 10px 20px rgba(0,0,0,0.6);
    }
    .main-menu-actions .btn-secondary {
         background: linear-gradient(45deg, #2c2c2c, #5a5a5a);
         border-color: #777;
    }
     .main-menu-actions .btn-secondary:hover {
        border-color: #8A2BE2;
        box-shadow: 0 0 25px #8A2BE2, 0 10px 20px rgba(0,0,0,0.6);
    }


    /* --- ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ --- */
    .input-field {
        background-color: #3C609E;
        color: #FFFFFF;
        border: 2px solid #325A9E;
        padding: 14px;
        width: 100%;
        margin: 0;
        border-radius: 12px;
        font-size: 1.1rem;
        font-family: 'Vazirmatn', sans-serif;
        text-align: center;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        outline: none;
    }

    .input-field::placeholder {
        color: #C0C0C0;
        opacity: 0.8;
    }
    .input-field:focus {
        outline: none;
        border-color: #FFB800;
        box-shadow: 0 0 10px rgba(255, 184, 0, 0.5);
    }

    .input-wrapper {
        position: relative;
        width: 85%;
        max-width: 350px;
        margin: 10px 0;
    }

    .input-wrapper::before,
    .input-wrapper::after,
    .input-wrapper .corner-dot {
        content: '';
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #FFB800;
        box-shadow: 0 0 6px #FFB800;
        z-index: 2;
    }

    .input-wrapper::before { top: 10px; left: 10px; }
    .input-wrapper::after { top: 10px; right: 10px; }
    .input-wrapper .corner-bottom-left-dot { bottom: 10px; left: 10px; }
    .input-wrapper .corner-bottom-right-dot { bottom: 10px; right: 10px; }

    /* --- Ø¹Ù†Ø§ÙˆÛŒÙ† Ùˆ Ù…ØªÙˆÙ† --- */
    h1, h2 {
        font-family: 'Lalezar', cursive;
        color: #FFB800;
        text-shadow: 0 0 15px rgba(255, 184, 0, 0.7), 0 0 10px rgba(255, 184, 0, 0.5);
        margin-top: 0;
        margin-bottom: 20px;
        letter-spacing: 1px;
        font-weight: 900;
    }

    p {
        font-size: 1.1rem;
        text-align: center;
        line-height: 1.6;
        margin-bottom: 30px;
    }

    /* --- ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… --- */
    #screen-register h1 { font-size: 2.8rem; }
    #screen-register p { font-size: 1.2rem; color: #E0E0E0; }

    .avatar-selection {
        display: flex;
        justify-content: center;
        margin: 25px 0;
        gap: 20px;
    }
    .avatar-option {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
        cursor: pointer;
        border: 4px solid transparent;
        transition: all 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        flex-shrink: 0;
    }
    .avatar-option.selected {
        border-color: #8A2BE2;
        box-shadow: 0 0 15px #8A2BE2, 0 0 25px #8A2BE2, 0 0 40px rgba(138, 43, 226, 0.7);
        transform: scale(1.05);
    }
    .avatar-option:hover:not(.selected) {
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(255,255,255,0.4);
    }

    /* --- ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ --- */
    #screen-loading { font-size: 1.8rem; color: #FFB800; text-shadow: 0 0 10px #FFB800; }

    /* --- Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ --- */
    #main-menu-header {
        position: absolute;
        top: 25px;
        width: 100%;
        padding: 0 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .user-info {
        display: flex;
        align-items: center;
        background: rgba(255,255,255,0.1);
        border-radius: 30px;
        padding: 5px 15px;
        cursor: pointer;
    }
    #user-avatar-display {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
        border: 3px solid #FFB800;
        margin-left: 10px; /* Ú©Ø§Ù‡Ø´ ÙØ§ØµÙ„Ù‡ */
        box-shadow: 0 0 10px rgba(255, 184, 0, 0.5);
        flex-shrink: 0;
    }
    #username-display { font-size: 1.3rem; font-weight: 700; color: #FFFFFF; }
    
    #creator-badge {
        background-color: #FFB800;
        color: #111;
        font-size: 0.8rem;
        font-weight: bold;
        padding: 4px 10px;
        border-radius: 12px;
        margin-right: 12px;
        text-shadow: none;
        transition: opacity 0.3s ease;
    }

    .icon-btn {
        font-size: 2.2rem;
        color: #FFFFFF;
        cursor: pointer;
        transition: transform 0.3s ease, color 0.3s ease, text-shadow 0.3s ease;
        background: none;
        border: none;
        padding: 5px;
        outline: none;
    }
    .icon-btn:hover {
        transform: rotate(90deg) scale(1.1);
        color: #FFB800;
        text-shadow: 0 0 10px #FFB800;
    }
    .icon-btn:focus, .icon-btn:active { outline: none; box-shadow: none; }

    /* --- Ù…Ù†ÙˆÛŒ Ø¢ÙˆØ§ØªØ§Ø± --- */
    #avatar-menu {
        position: absolute;
        background-color: rgba(30, 40, 70, 0.95);
        backdrop-filter: blur(8px);
        border-radius: 15px;
        border: 1px solid #325A9E;
        padding: 10px;
        z-index: 110;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    #avatar-menu.hidden {
        opacity: 0;
        pointer-events: none;
        transform: translateY(-10px);
    }
    .avatar-menu-btn {
        background: none;
        border: none;
        color: #FFF;
        font-family: 'Vazirmatn', sans-serif;
        font-size: 1rem;
        padding: 12px 20px;
        width: 100%;
        text-align: right;
        cursor: pointer;
        border-radius: 8px;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .avatar-menu-btn:hover {
        background-color: rgba(255, 184, 0, 0.2);
    }

    /* --- Ù†ÙˆØ§Ø± Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ† ØµÙØ­Ù‡ --- */
    #bottom-nav-bar {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(to top, rgba(0, 0, 0, 1), rgba(10, 10, 20, 0.85));
        backdrop-filter: blur(10px);
        display: flex;
        justify-content: space-around;
        align-items: stretch;
        padding: 0;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        z-index: 50;
        height: 70px;
        border-top: 1px solid rgba(255, 184, 0, 0.5);
    }
    .nav-btn {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #A9A9A9;
        background: none;
        border: none;
        font-family: 'Vazirmatn', sans-serif;
        font-weight: 700;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
        gap: 4px;
        padding: 5px 10px;
        outline: none;
        border-radius: 0;
        margin: 0;
    }
    .nav-btn:hover, .nav-btn.active {
        color: #FFFFFF;
        background-color: rgba(255, 184, 0, 0.15);
        transform: translateY(-3px);
    }
    .nav-btn .nav-icon {
        width: 28px;
        height: 28px;
        fill: currentColor;
        transition: all 0.3s ease;
    }

    /* --- Ù¾Ù†Ù„â€ŒÙ‡Ø§ (Ø¨Ø§Ø²Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡) --- */
    .panel-content {
        background-color: #1F2A47;
        border: 2px solid #325A9E;
        border-radius: 20px;
        padding: 30px;
        width: 95%;
        max-width: 500px;
        text-align: center;
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        position: relative;
    }

    .panel-content::before, .panel-content::after, .panel-dot {
        content: '';
        position: absolute;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #FFB800;
        box-shadow: 0 0 8px #FFB800;
        z-index: 2;
    }

    .panel-content::before { top: 15px; left: 15px; }
    .panel-content::after { top: 15px; right: 15px; }
    .panel-dot.corner-bottom-left-dot { bottom: 15px; left: 15px; }
    .panel-dot.corner-bottom-right-dot { bottom: 15px; right: 15px; }

    .close-panel-btn {
        position: absolute;
        top: 15px;
        left: 15px;
        font-size: 1.8rem;
        line-height: 1;
        color: #FFFFFF;
        cursor: pointer;
        background: rgba(0,0,0,0.4);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease, transform 0.3s ease;
        outline: none;
        z-index: 3;
    }
    .close-panel-btn:hover {
        background: rgba(255,0,0,0.6);
        transform: scale(1.1) rotate(90deg);
    }
    .close-panel-btn:focus, .close-panel-btn:active { outline: none; box-shadow: none; }

    /* --- Ù¾Ù†Ù„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ùˆ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢ÙˆØ§ØªØ§Ø± --- */
    #profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
        border: 5px solid #FFB800;
        margin: 0 auto 25px;
        box-shadow: 0 0 20px rgba(255, 184, 0, 0.6);
    }

    .profile-info { text-align: right; margin-top: 20px; }
    .profile-info p { text-align: right; font-size: 1.2rem; margin-bottom: 15px; }
    .profile-info span { font-weight: 700; color: #FFB800; margin-right: 10px; }
    #avatar-store-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 20px;
        margin-top: 20px;
        max-height: 50vh;
        overflow-y: auto;
        padding: 10px;
    }

    /* --- [ØªØºÛŒÛŒØ±] Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯ --- */
    #game-modes-grid {
        display: grid;
        grid-template-columns: 1fr; /* ØªÚ© Ø³ØªÙˆÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ØªØ± ØªÙˆØ¶ÛŒØ­Ø§Øª */
        gap: 20px;
        margin-top: 30px;
        width: 100%;
        max-width: 350px;
    }
    .game-mode-card {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 15px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 120px; /* Ú©Ø§Ù‡Ø´ Ø§Ø±ØªÙØ§Ø¹ */
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        position: relative;
        overflow: hidden;
        border: 2px solid transparent;
        outline: none;
    }
    .game-mode-card:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: 0 8px 25px rgba(0,0,0,0.5);
        background: rgba(138, 43, 226, 0.3);
        border-color: #8A2BE2;
    }
    .game-mode-card:focus, .game-mode-card:active {
        outline: none;
        box-shadow: 0 0 10px #8A2BE2;
        transform: translateY(-5px) scale(1.03);
    }

    .game-mode-card h3 {
        font-family: 'Lalezar', cursive;
        margin: 0 0 10px 0;
        font-size: 1.5rem;
        color: #FFFFFF;
        text-shadow: 0 0 5px rgba(255,255,255,0.5);
    }
    .game-mode-card p {
        font-size: 0.9rem;
        color: #C0C0C0;
        line-height: 1.5;
        margin: 0;
        font-weight: 400;
    }


    /* --- ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ Ø±Ù¾ --- */
    #rap-game-content { width: 90%; max-width: 550px; text-align: center; }
    .back-btn { position: absolute; top: 25px; right: 25px; font-size: 2.2rem; }
    #display-lyrics {
        font-family: 'Vazirmatn', sans-serif; font-size: 1.6rem; font-weight: 700; color: #FFFFFF;
        background: rgba(0,0,0,0.6); padding: 25px; border-radius: 15px; margin-bottom: 25px;
        min-height: 80px; display: flex; align-items: center; justify-content: center;
        line-height: 1.8; box-shadow: 0 0 15px rgba(255,255,255,0.1);
    }
    #feedback-message {
        font-family: 'Lalezar', cursive; font-size: 1.4rem; font-weight: bold; margin: 20px 0;
        min-height: 30px; transition: color 0.3s ease;
    }

    .feedback-success { color: #00FF7F; animation: glow 1s ease-in-out forwards; }
    .feedback-failure { color: #FF4444; animation: shake 0.5s ease-in-out; }

    @keyframes glow {
        0%, 100% { text-shadow: 0 0 5px #00FF7F, 0 0 0px #00FF7F; }
        50% { text-shadow: 0 0 20px #00FF7F, 0 0 10px #00FF7F; }
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); } 10%, 50%, 90% { transform: translateX(-8px); } 30%, 70% { transform: translateX(8px); }
    }

    /* --- Ù¾ÛŒØ§Ù… Toast --- */
    #message-toast {
        position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
        background-color: #FFB800; color: #111; padding: 15px 30px; border-radius: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 200; font-size: 1.1rem; font-weight: bold;
        transition: bottom 0.4s ease-in-out; font-family: 'Vazirmatn', sans-serif; text-align: center;
    }
    #message-toast.show { bottom: 85px; }
</style>
</head>
<body>

<div class="background-image"></div>

<!-- 1. ØµÙØ­Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… -->
<div id="screen-register" class="screen">
    <div class="avatar-selection" id="avatar-container"></div>
    <div class="input-wrapper">
        <input type="text" id="username-input" class="input-field" placeholder="Ø§Ø³Ù… Ø±Ù¾Ø± Ø®ÙˆØ¯ØªÙˆ Ø¨Ù†ÙˆÛŒØ³...">
        <span class="corner-dot corner-bottom-left-dot"></span><span class="corner-dot corner-bottom-right-dot"></span>
    </div>
    <div class="input-wrapper">
        <input type="number" id="age-input" class="input-field" placeholder="Ø³Ù† Ø´Ù…Ø§">
        <span class="corner-dot corner-bottom-left-dot"></span><span class="corner-dot corner-bottom-right-dot"></span>
    </div>
    <div class="input-wrapper">
        <input type="password" id="password-input" class="input-field" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <span class="corner-dot corner-bottom-left-dot"></span><span class="corner-dot corner-bottom-right-dot"></span>
    </div>
    <div class="input-wrapper">
        <input type="password" id="confirm-password-input" class="input-field" placeholder="ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
        <span class="corner-dot corner-bottom-left-dot"></span><span class="corner-dot corner-bottom-right-dot"></span>
    </div>
    <button id="register-btn" class="btn" style="margin-top: 20px;">Ø«Ø¨Øª Ù†Ø§Ù…</button>
</div>

<!-- 2. ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ -->
<div id="screen-loading" class="screen hidden">
    <div id="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
</div>

<!-- 3. Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ -->
<div id="screen-main-menu" class="screen hidden">
    <div id="main-menu-header">
        <button id="settings-btn" class="icon-btn">âš™ï¸</button>
        <div class="user-info" id="user-info-header">
            <span id="username-display"></span>
            <span id="creator-badge" class="hidden">Ø³Ø§Ø²Ù†Ø¯Ù‡</span>
            <div id="user-avatar-display"></div>
        </div>
    </div>

    <div id="avatar-menu" class="hidden">
        <button class="avatar-menu-btn" id="profile-btn">
            <span>ğŸ‘¤</span> Ù¾Ø±ÙˆÙØ§ÛŒÙ„
        </button>
        <button class="avatar-menu-btn" id="avatar-store-btn-from-menu">
            <span>ğŸ­</span> ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢ÙˆØ§ØªØ§Ø±
        </button>
    </div>
    
    <div class="main-menu-actions">
        <button id="start-flow-btn" class="btn">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
        <button id="online-game-btn" class="btn btn-secondary">Ø¨Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ†</button>
    </div>

    <div id="bottom-nav-bar">
        <button class="nav-btn" data-message="Ù…Ø³ÛŒØ± (Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...)">
            <svg class="nav-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/>
            </svg>
            Ù…Ø³ÛŒØ±
        </button>
        <button class="nav-btn" data-message="Ø¨ØªÙ„ (Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...)">
            <svg class="nav-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M20.71,3.29a1,1,0,0,0-1.42,0L3.29,19.29a1,1,0,0,0,0,1.42,1,1,0,0,0,1.42,0L20.71,4.71a1,1,0,0,0,0-1.42Z M3.29,4.71,19.29,20.71a1,1,0,0,0,1.42,0,1,1,0,0,0,0-1.42L4.71,3.29a1,1,0,0,0-1.42,0Z"/>
            </svg>
            Ø¨ØªÙ„
        </button>
        <button id="shop-nav-btn" class="nav-btn">
            <svg class="nav-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M17,18a2,2,0,0,1-2,2,2,2,0,0,1-2-2,2,2,0,0,1,2-2,2,2,0,0,1,2,2M1,4H3.27l.94,2H20a1,1,0,0,1,.8,1.6L17.21,12.83a2,2,0,0,1-1.7,1.17H8.34l-.94,2H17v2H7a2,2,0,0,1-2-2c0-.35.09-.68.24-1L6,11.59l-1.35-2.45L3.4,4H1V4m6,14a2,2,0,0,1-2,2,2,2,0,0,1-2-2,2,2,0,0,1,2-2,2,2,0,0,1,2,2Z"/>
            </svg>
            ÙØ±ÙˆØ´Ú¯Ø§Ù‡
        </button>
    </div>
</div>

<!-- 4. ØµÙØ­Ù‡ Ø¨Ø§Ø²ÛŒ Ø±Ù¾ -->
<div id="screen-rap-game" class="screen hidden">
    <button id="game-back-btn" class="icon-btn back-btn">â¬…ï¸</button>
    <div id="rap-game-content">
        <h2>ØªÚ©Ù…ÛŒÙ„ ØªÚ©Ø³</h2>
        <p>ÛŒÙ‡ Ø®Ø· Ø§Ø² ØªÚ©Ø³ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´Ù‡ØŒ Ø¨Ø§ÛŒØ¯ Ø®Ø· Ø¨Ø¹Ø¯ÛŒ Ø±Ùˆ Ø·ÙˆØ±ÛŒ Ø¨Ú¯ÛŒ Ú©Ù‡ Ø¨Ø§Ù‡Ø§Ø´ Ù‡Ù…â€ŒÙ‚Ø§ÙÛŒÙ‡ Ø¨Ø§Ø´Ù‡ Ùˆ ÙÙ„Ùˆ Ø­ÙØ¸ Ø¨Ø´Ù‡.</p>
        <div id="display-lyrics">...</div>
        <div id="feedback-message"></div>
        <input type="text" id="rap-input" class="input-field" placeholder="Ø®Ø· Ø¨Ø¹Ø¯ÛŒÙ Ø±Ù¾ Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³...">
        <button id="submit-rap-btn" class="btn">Ø¨ÙØ±Ø³Øª</button>
        <button id="next-rap-btn" class="btn btn-secondary hidden">ØªÚ©Ø³ Ø¨Ø¹Ø¯ÛŒ</button>
    </div>
</div>

<!-- Ù¾Ù†Ù„â€ŒÙ‡Ø§ -->
<!-- 5. Ù¾Ù†Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
<div id="panel-settings" class="panel hidden">
    <div class="panel-content">
        <button class="close-panel-btn" data-panel="settings">X</button>
        <span class="panel-dot corner-bottom-left-dot"></span><span class="panel-dot corner-bottom-right-dot"></span>
        <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒØ±Ø§Ù† Ø±Ù¾</h2>
        <div class="input-wrapper" style="margin-top: 20px;">
            <input type="text" id="gift-code-input" class="input-field" placeholder="Ú©Ø¯ Ù‡Ø¯ÛŒÙ‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
        </div>
        <button id="submit-gift-code-btn" class="btn btn-secondary">Ø§Ø¹Ù…Ø§Ù„ Ú©Ø¯</button>
        <hr style="border-color: #325A9E; width: 80%; margin: 25px auto;">
        <button class="btn" data-message="Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù† (Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...)">Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù†</button>
        <button class="btn" data-message="Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ (Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...)">Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</button>
    </div>
</div>

<!-- 6. Ù¾Ù†Ù„ Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ -->
<div id="panel-game-modes" class="panel hidden">
    <div class="panel-content">
        <button class="close-panel-btn" data-panel="gameModes">X</button>
        <span class="panel-dot corner-bottom-left-dot"></span><span class="panel-dot corner-bottom-right-dot"></span>
        <!-- [ØªØºÛŒÛŒØ±] Ø¹Ù†ÙˆØ§Ù† Ù¾Ù†Ù„ -->
        <h2>Ø±Ù¾ Ø±ÙˆÙ…</h2>
        <!-- [ØªØºÛŒÛŒØ±] Ø­Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§Ø²ÛŒ -->
        <div id="game-modes-grid">
            <div class="game-mode-card" data-message="Ø­Ø¯Ø³ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡ (Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...)">
                <h3>Ø­Ø¯Ø³ Ø®ÙˆØ§Ù†Ù†Ø¯Ù‡</h3>
                <p>ÛŒÙ‡ Ø¨ÛŒØª Ø§Ø² ÛŒÙ‡ Ø±Ù¾Ø± Ù…ÛŒØ§Ø¯ Ùˆ ØªÙˆ Ø¨Ø§ÛŒØ¯ Ø¨Ú¯ÛŒ Ú©ÛŒÙ‡. Ø§Ú¯Ù‡ Ø¨ÛŒØª Ø¨Ø¹Ø¯ÛŒ Ø±Ùˆ Ù‡Ù… Ø¨Ú¯ÛŒØŒ Ø§Ù…ØªÛŒØ§Ø²Øª Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± Ù…ÛŒØ´Ù‡!</p>
            </div>
            <div class="game-mode-card" data-message="ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±Ù¾ (Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...)">
                <h3>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±Ù¾</h3>
                <p>Ø³ÙˆØ§Ù„Ø§ÛŒ Ú†Ù†Ø¯ Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø§ÙˆÙ„ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ø±Ù¾ ÙØ§Ø±Ø³ÛŒ Ùˆ Ø§ØªÙØ§Ù‚Ø§Øª Ù…Ù‡Ù…Ø´.</p>
            </div>
            <div id="start-rap-game-card" class="game-mode-card">
                <h3>ØªÚ©Ù…ÛŒÙ„ ØªÚ©Ø³</h3>
                <p>ØªÚ©Ø³ Ø±Ùˆ Ø¨Ø§ ÛŒÙ‡ Ú©Ù„Ù…Ù‡ Ù‡Ù… Ù‚Ø§ÙÛŒÙ‡ Ùˆ Ø¨Ø§ Ù…Ø¹Ù†ÛŒ Ú©Ø§Ù…Ù„ Ú©Ù†.</p>
            </div>
        </div>
    </div>
</div>

<!-- 7. Ù¾Ù†Ù„ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ -->
<div id="panel-profile" class="panel hidden">
    <div class="panel-content">
        <button class="close-panel-btn" data-panel="profile">X</button>
        <span class="panel-dot corner-bottom-left-dot"></span><span class="panel-dot corner-bottom-right-dot"></span>
        <h2>Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø±Ù¾Ø±</h2>
        <div id="profile-avatar"></div>
        <div class="profile-info">
            <p>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <span id="profile-username"></span></p>
            <p>Ø³Ù†: <span id="profile-age"></span></p>
            <p>ØªØ¹Ø¯Ø§Ø¯ Ø¢ÙˆØ§ØªØ§Ø±Ù‡Ø§: <span id="profile-avatar-count"></span></p>
            <p>ØªØ¹Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: <span id="profile-games-played"></span></p>
            <p>Ø³Ø§Ø¹Øª Ø¨Ø§Ø²ÛŒ: <span id="profile-play-time"></span></p>
        </div>
    </div>
</div>

<!-- 8. Ù¾Ù†Ù„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢ÙˆØ§ØªØ§Ø± -->
<div id="panel-avatar-store" class="panel hidden">
    <div class="panel-content">
        <button class="close-panel-btn" data-panel="avatarStore">X</button>
        <span class="panel-dot corner-bottom-left-dot"></span><span class="panel-dot corner-bottom-right-dot"></span>
        <h2>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢ÙˆØ§ØªØ§Ø±</h2>
        <p>Ø¢ÙˆØ§ØªØ§Ø± Ø¬Ø¯ÛŒØ¯Øª Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†</p>
        <div id="avatar-store-grid"></div>
    </div>
</div>

<div id="message-toast"></div>

<script>
    // --- ØªÙ…Ø§Ù… Ú©Ø¯ Ø¬Ø§ÙˆØ§ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯ ---
    // ... (Ú©Ø¯ Ø¬Ø§ÙˆØ§ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø´Ù…Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯)
    const config = {
        assets: {
            avatars: [
                "https://s6.uupload.ir/files/img_Û²Û°Û²ÛµÛ±Û°Û²Û´_Û±Û¹Û±Û³Û°Û±_utr.png",
                "https://s6.uupload.ir/files/img_Û²Û°Û²ÛµÛ±Û°Û²Û´_Û±Û¹Û±Û²Û´Û´_dwyf.png",
                "https://s6.uupload.ir/files/img_Û²Û°Û²ÛµÛ±Û°Û²Û³_Û²Û°Û²Û¹Û´Û·_9o3p.png"
            ]
        },
        screens: {
            loading: { duration_seconds: 2 },
            rap_game: {
                feedback_messages: {
                    success: "Ø¯Ù…Øª Ú¯Ø±Ù…! Ù‚Ø§ÙÛŒÙ‡ ÙÙØª Ø¨ÙˆØ¯",
                    failure: "Ù†Ù‡ Ø¯Ø§Ø¯Ø§ØŒ Ù‚Ø§ÙÛŒÙ‡ Ø®Ø±Ø§Ø¨ Ø´Ø¯"
                }
            }
        },
        creator_gift_code: "ak9090a90k80"
    };

    const rapChallenges = [
        { line: "Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø¨ Ø´Ø¯ Ùˆ Ù…Ù† Ø¨ÛŒØ¯Ø§Ø±...", rhymes: ["Ø¨ÛŒÙ…Ø§Ø±", "Ø³ÛŒÚ¯Ø§Ø±", "Ø¯ÛŒØ¯Ø§Ø±", "Ø¯ÛŒÙˆØ§Ø±", "Ø¨ÛŒÚ©Ø§Ø±", "ØªÚ©Ø±Ø§Ø±"] },
        { line: "Ú©Ù„Ù…Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ù…ÛŒØ°Ø§Ø±Ù… Ú©Ù†Ø§Ø± Ù‡Ù… Ø¨Ø§ Ø¯Ù‚Øª...", rhymes: ["Ø³Ø±Ø¹Øª", "ÙˆÙ‚Øª", "Ù†ÙØ±Øª", "Ø±Ù‚Øª", "Ú©ÛŒÙÛŒØª", "Ù‚Ø³Ù…Øª"] },
        { line: "Ø§ÛŒÙ†Ø¬Ø§ ØªÙ‡Ø±Ø§Ù†Ù‡ ÛŒØ¹Ù†ÛŒ Ø´Ù‡Ø± Ù‡Ø²Ø§Ø± Ø±Ù†Ú¯...", rhymes: ["Ø¬Ù†Ú¯", "Ø³Ù†Ú¯", "ØªÙ†Ú¯", "Ù¾Ù„Ù†Ú¯", "Ù‚Ø´Ù†Ú¯", "ØªÙÙ†Ú¯"] },
        { line: "Ù…ÛŒÚ¯Ù‡ Ø­Ø§Ù„Ø´ Ø¨Ø¯Ù‡ØŒ Ø­Ø§Ù„Ù… Ø§Ø² Ø§ÙˆÙ† Ø¨Ø¯ØªØ±Ù‡...", rhymes: ["Ø¯ÙØªØ±Ù‡", "Ø³Ø±ØªØ±Ù‡", "Ø¨Ù‡ØªØ±Ù‡", "Ø§ÙˆÙ„Ù‡", "Ø§ÛŒÙ†ÙˆØ±", "Ø§ÙˆÙ†ÙˆØ±"] }
    ];
    let currentChallenge;
    let usedChallengeIndices = [];

    const state = {
        username: '',
        age: 0,
        avatar: config.assets.avatars[0],
        userId: '',
        gamesPlayed: 0,
        playTime: 0,
        isCreator: false
    };
    
    const dom = {
        screens: {
            register: document.getElementById('screen-register'),
            loading: document.getElementById('screen-loading'),
            mainMenu: document.getElementById('screen-main-menu'),
            rapGame: document.getElementById('screen-rap-game'),
        },
        panels: {
            settings: document.getElementById('panel-settings'),
            gameModes: document.getElementById('panel-game-modes'),
            profile: document.getElementById('panel-profile'),
            avatarStore: document.getElementById('panel-avatar-store'),
        },
        register: {
            avatarContainer: document.getElementById('avatar-container'),
            usernameInput: document.getElementById('username-input'),
            ageInput: document.getElementById('age-input'),
            passwordInput: document.getElementById('password-input'),
            confirmPasswordInput: document.getElementById('confirm-password-input'),
            registerBtn: document.getElementById('register-btn'),
        },
        mainMenu: {
            settingsBtn: document.getElementById('settings-btn'),
            userInfoHeader: document.getElementById('user-info-header'),
            usernameDisplay: document.getElementById('username-display'),
            avatarDisplay: document.getElementById('user-avatar-display'),
            creatorBadge: document.getElementById('creator-badge'),
            avatarMenu: document.getElementById('avatar-menu'),
            profileBtn: document.getElementById('profile-btn'),
            avatarStoreBtnFromMenu: document.getElementById('avatar-store-btn-from-menu'),
            startFlowBtn: document.getElementById('start-flow-btn'),
            onlineGameBtn: document.getElementById('online-game-btn'),
            shopNavBtn: document.getElementById('shop-nav-btn'),
        },
        rapGame: {
            displayLyrics: document.getElementById('display-lyrics'),
            feedbackMessage: document.getElementById('feedback-message'),
            rapInput: document.getElementById('rap-input'),
            submitRapBtn: document.getElementById('submit-rap-btn'),
            nextRapBtn: document.getElementById('next-rap-btn'),
            gameBackBtn: document.getElementById('game-back-btn'),
        },
        gameModes: {
            startRapGameCard: document.getElementById('start-rap-game-card'),
        },
        profilePanel: {
            avatar: document.getElementById('profile-avatar'),
            username: document.getElementById('profile-username'),
            age: document.getElementById('profile-age'),
            avatarCount: document.getElementById('profile-avatar-count'),
            gamesPlayed: document.getElementById('profile-games-played'),
            playTime: document.getElementById('profile-play-time'),
        },
        avatarStore: {
            grid: document.getElementById('avatar-store-grid'),
        },
        settingsPanel: {
            giftCodeInput: document.getElementById('gift-code-input'),
            submitGiftCodeBtn: document.getElementById('submit-gift-code-btn'),
        },
        closePanelBtns: document.querySelectorAll('.close-panel-btn'),
        messageToast: document.getElementById('message-toast'),
        buttonsWithMessages: document.querySelectorAll('[data-message]'),
    };

    function showScreen(screenId) {
        Object.values(dom.screens).forEach(screen => screen.classList.add('hidden'));
        if (dom.screens[screenId]) dom.screens[screenId].classList.remove('hidden');
    }

    function showPanel(panelId) {
        if (dom.panels[panelId]) dom.panels[panelId].classList.remove('hidden');
    }

    function hidePanel(panelId) {
        if (dom.panels[panelId]) dom.panels[panelId].classList.add('hidden');
    }

    function hideAllPanels() {
        Object.values(dom.panels).forEach(panel => panel.classList.add('hidden'));
    }

    function showMessage(message) {
        dom.messageToast.textContent = message;
        dom.messageToast.classList.add('show');
        setTimeout(() => dom.messageToast.classList.remove('show'), 2500);
    }

    function generateRandomId(length) {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
        return result;
    }

    function createAvatarElement(avatarUrl, onClickCallback) {
        const avatarDiv = document.createElement('div');
        avatarDiv.classList.add('avatar-option');
        avatarDiv.style.backgroundImage = `url(${avatarUrl})`;
        avatarDiv.dataset.url = avatarUrl;
        avatarDiv.addEventListener('click', () => onClickCallback(avatarUrl, avatarDiv));
        return avatarDiv;
    }

    function loadAvatarsForRegister() {
        dom.register.avatarContainer.innerHTML = '';
        config.assets.avatars.forEach((avatarUrl, index) => {
            const avatarDiv = createAvatarElement(avatarUrl, (url, element) => {
                document.querySelectorAll('#avatar-container .avatar-option').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                state.avatar = url;
            });
            if (index === 0) avatarDiv.classList.add('selected');
            dom.register.avatarContainer.appendChild(avatarDiv);
        });
    }

    function loadAvatarsToStore() {
        dom.avatarStore.grid.innerHTML = '';
        config.assets.avatars.forEach(avatarUrl => {
            const avatarDiv = createAvatarElement(avatarUrl, (url, element) => {
                state.avatar = url;
                setupMainMenu();
                document.querySelectorAll('#avatar-store-grid .avatar-option').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                showMessage("Ø¢ÙˆØ§ØªØ§Ø± Ø´Ù…Ø§ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!");
                setTimeout(() => hidePanel('avatarStore'), 500);
            });
            if (avatarUrl === state.avatar) avatarDiv.classList.add('selected');
            dom.avatarStore.grid.appendChild(avatarDiv);
        });
    }

    function setupMainMenu() {
        dom.mainMenu.usernameDisplay.textContent = state.username;
        dom.mainMenu.avatarDisplay.style.backgroundImage = `url(${state.avatar})`;
        if (state.isCreator) {
            dom.mainMenu.creatorBadge.classList.remove('hidden');
        } else {
            dom.mainMenu.creatorBadge.classList.add('hidden');
        }
    }

    function setupProfilePanel() {
        dom.profilePanel.avatar.style.backgroundImage = `url(${state.avatar})`;
        dom.profilePanel.username.textContent = state.username;
        dom.profilePanel.age.textContent = state.age;
        dom.profilePanel.avatarCount.textContent = config.assets.avatars.length;
        dom.profilePanel.gamesPlayed.textContent = state.gamesPlayed;
        const minutes = Math.floor(state.playTime / 60);
        const seconds = state.playTime % 60;
        dom.profilePanel.playTime.textContent = `${minutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ùˆ ${seconds} Ø«Ø§Ù†ÛŒÙ‡`;
    }

    function loadChallenge() {
        if (usedChallengeIndices.length === rapChallenges.length) usedChallengeIndices = [];
        let newIndex;
        do {
            newIndex = Math.floor(Math.random() * rapChallenges.length);
        } while (usedChallengeIndices.includes(newIndex));
        usedChallengeIndices.push(newIndex);
        currentChallenge = rapChallenges[newIndex];

        dom.rapGame.displayLyrics.textContent = currentChallenge.line;
        dom.rapGame.rapInput.value = '';
        dom.rapGame.feedbackMessage.textContent = '';
        dom.rapGame.feedbackMessage.className = 'feedback-message';
        dom.rapGame.nextRapBtn.classList.add('hidden');
        dom.rapGame.submitRapBtn.classList.remove('hidden');
        dom.rapGame.rapInput.disabled = false;
        dom.rapGame.rapInput.focus();
    }

    function checkRhyme() {
        const userInput = dom.rapGame.rapInput.value.trim();
        if (!userInput) return showMessage("Ø§ÙˆÙ„ Ø¨Ø§ÛŒØ¯ ÛŒÙ‡ Ú†ÛŒØ²ÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒ!");

        const lastWord = userInput.split(' ').pop().replace(/[.,!ØŸØŒØ›]/g, '').toLowerCase();
        const feedbackMsg = dom.rapGame.feedbackMessage;

        if (currentChallenge.rhymes.includes(lastWord)) {
            feedbackMsg.textContent = config.screens.rap_game.feedback_messages.success;
            feedbackMsg.className = 'feedback-message feedback-success';
            dom.rapGame.nextRapBtn.classList.remove('hidden');
            dom.rapGame.submitRapBtn.classList.add('hidden');
            dom.rapGame.rapInput.disabled = true;
            state.gamesPlayed++;
        } else {
            feedbackMsg.textContent = config.screens.rap_game.feedback_messages.failure;
            feedbackMsg.className = 'feedback-message feedback-failure';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadAvatarsForRegister();

        dom.register.registerBtn.addEventListener('click', () => {
            const username = dom.register.usernameInput.value.trim();
            const age = dom.register.ageInput.value;
            const password = dom.register.passwordInput.value;

            if (!username || !age || !password) return showMessage("Ù„Ø·ÙØ§Ù‹ Ù‡Ù…Ù‡â€ŒÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ùˆ Ù¾Ø± Ú©Ù†.");
            if (password !== dom.register.confirmPasswordInput.value) return showMessage("Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ù‡Ù… Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ù†.");

            state.username = username;
            state.age = age;
            state.userId = generateRandomId(6);

            showScreen('loading');

            setTimeout(() => {
                setupMainMenu();
                showScreen('mainMenu');
            }, config.screens.loading.duration_seconds * 1000);
        });
        
        dom.mainMenu.settingsBtn.addEventListener('click', () => showPanel('settings'));
        dom.mainMenu.startFlowBtn.addEventListener('click', () => showPanel('gameModes'));
        dom.mainMenu.onlineGameBtn.addEventListener('click', () => showMessage('Ø¨Ø§Ø²ÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† (Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ...)'));

        dom.mainMenu.userInfoHeader.addEventListener('click', (e) => {
            e.stopPropagation();
            const rect = dom.mainMenu.userInfoHeader.getBoundingClientRect();
            dom.mainMenu.avatarMenu.style.top = `${rect.bottom + 10}px`;
            dom.mainMenu.avatarMenu.style.right = `${window.innerWidth - rect.right}px`;
            dom.mainMenu.avatarMenu.classList.toggle('hidden');
        });
        
        const openAvatarStore = () => {
            loadAvatarsToStore();
            showPanel('avatarStore');
            dom.mainMenu.avatarMenu.classList.add('hidden');
        };

        dom.mainMenu.profileBtn.addEventListener('click', () => {
            setupProfilePanel();
            showPanel('profile');
            dom.mainMenu.avatarMenu.classList.add('hidden');
        });
        
        dom.mainMenu.avatarStoreBtnFromMenu.addEventListener('click', openAvatarStore);
        dom.mainMenu.shopNavBtn.addEventListener('click', openAvatarStore);

        dom.closePanelBtns.forEach(btn => {
            btn.addEventListener('click', () => hidePanel(btn.dataset.panel));
        });

        dom.gameModes.startRapGameCard.addEventListener('click', () => {
            hideAllPanels();
            loadChallenge();
            showScreen('rapGame');
        });

        // Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ø§ÛŒØ¯ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´ÙˆØ¯ ØªØ§ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ù‡Ù… Ø¯Ø± Ø¨Ø± Ø¨Ú¯ÛŒØ±Ø¯
        document.querySelectorAll('[data-message]').forEach(element => {
             element.addEventListener('click', () => showMessage(element.dataset.message));
        });
        
        dom.settingsPanel.submitGiftCodeBtn.addEventListener('click', () => {
            const code = dom.settingsPanel.giftCodeInput.value.trim();
            if (code === config.creator_gift_code) {
                state.isCreator = true;
                setupMainMenu();
                showMessage("ØªØ¨Ø±ÛŒÚ©! Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø´Ù†Ø§Ø®ØªÙ‡ Ø´Ø¯ÛŒØ¯.");
                hidePanel('settings');
                dom.settingsPanel.giftCodeInput.value = '';
            } else {
                showMessage("Ú©Ø¯ Ù‡Ø¯ÛŒÙ‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
            }
        });

        dom.rapGame.submitRapBtn.addEventListener('click', checkRhyme);
        dom.rapGame.nextRapBtn.addEventListener('click', loadChallenge);
        dom.rapGame.gameBackBtn.addEventListener('click', () => {
            hideAllPanels();
            showScreen('mainMenu');
        });

        dom.rapGame.rapInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') { e.preventDefault(); checkRhyme(); }
        });

        document.addEventListener('click', (e) => {
            if (!dom.mainMenu.avatarMenu.classList.contains('hidden') && !dom.mainMenu.userInfoHeader.contains(e.target)) {
                dom.mainMenu.avatarMenu.classList.add('hidden');
            }
        });

        setInterval(() => {
            if(!dom.screens.rapGame.classList.contains('hidden')) {
                state.playTime++;
            }
        }, 1000);
    });
</script>
</body>
</html>
